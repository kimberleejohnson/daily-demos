<html>
  <head>
    <title>Video chat</title>
    <script src="https://unpkg.com/@daily-co/daily-js"></script>
    <link rel="stylesheet" href="./call-styling.css" />
  </head>
  <body onload="run()">
    <iframe id="call-frame" allow="camera; microphone; autoplay"></iframe>

    <div id="ui-container">
      <div id="ui-local">
        <p>Loading your video feedâ€¦</p>
      </div>
      <div id="ui-alone"></div>
      <div id="ui-controller">
        <div
          onclick="callFrame.setLocalVideo(!callFrame.localVideo())"
          class="ui-controller-control"
        >
          <p>Toggle camera</p>
          <img
            src="../shared-assets/icon-camera.svg"
            alt="Toggle Camera On/Off"
          />
        </div>
        <div
          onclick="callFrame.setLocalAudio(!callFrame.localAudio())"
          class="ui-controller-control"
        >
          <p>Toggle microphone</p>
          <img
            src="../shared-assets/icon-microphone.svg"
            alt="Toggle Microphone On/Off"
          />
        </div>
        <div onclick="toggleHandIcon()" class="ui-controller-control">
          <p id="handraise-label">Raise hand</p>
          <img src="../shared-assets/icon-raised-hand.png" alt="Hand icon" />
        </div>
        <div onclick="toggleScreenShare()" class="ui-controller-control">
          <p id="screenshare-label">Start a screen share</p>
          <img src="../shared-assets/icon-screenshare.svg" alt="Screen share" />
        </div>
        <hr />
        <div id="leave-call-div" class="ui-controller-control">
          <p id="leave-call-label" style="color: #ff3b30;"></p>
          <img src="../shared-assets/icon-leave.svg" alt="Leave call" />
        </div>
      </div>
      <div id="ui-participant">
        <p>Participants</p>
        <div class="ui-participant-local">
          <em>You</em>
          <img
            id="local-hand"
            src="../shared-assets/icon-raised-hand.png"
            alt="Raised hand"
            style="display: none;"
          />
          <div id="ui-participant-guests"></div>
        </div>
      </div>
    </div>

    <script>
      let url,
        token,
        message,
        guestList,
        isCurrentlyScreenSharing,
        isCurrentlyRaisingHand;

      // Declare empty object to track hand state
      let handState = {};

      function showEvent(e) {
        console.log("video call event -->", e);
      }

      // When caller joins
      async function joinedCall() {
        showEvent(e);
        // Set the handraising status to false
        isCurrentlyRaisingHand = false;
        // And send that message to everyone, so the function called on 'app-message' is invoked to update list
        message = {
          handStatus: isCurrentlyRaisingHand,
        };
        setTimeout(() => {
          callFrame.sendAppMessage(message, "*");
        }, 2500);

        // Dynamically  update whether leave call button is displayed
        document.getElementById("leave-call-label").innerHTML = "Leave call";
        document.getElementById("leave-call-div").onclick = () => {
          callFrame.leave();
        };
      }

      // Something when caller leaves
      async function leftCall(e) {
        showEvent(e);
        document.getElementById("leave-call-label").innerHTML = "Join call";
        document.getElementById("leave-call-div").onclick = () =>
          callFrame.join();
      }

      async function updateEvent(e) {
        showEvent(e);
        let ps = callFrame.participants();
        let wrapper = document.getElementById("ui-participant-guests");

        // update controller ui for joining/leaving the meeting and
        // for local screenshare start/stop
        if (ps.local) {
          if (ps.local.screen && !isCurrentlyScreenSharing) {
            isCurrentlyScreenSharing = true;
            document.getElementById("screenshare-label").innerHTML =
              "Stop sharing your screen";
          } else if (!ps.local.screen && isCurrentlyScreenSharing) {
            isCurrentlyScreenSharing = false;
            document.getElementById("screenshare-label").innerHTML =
              "Start a screen share";
          }
        }
      }

      async function run() {
        // To test this feature quickly, I'm hard-coding my meeting room.
        // This is NOT a best practice. For more on creating rooms securely, head to [LINK]
        room = { url: "https://kimberlee.daily.co/hello" };
        ownerLink = room.url;

        callFrame = window.DailyIframe.wrap(
          document.getElementById("call-frame"),
          { customLayout: true }
        );
        callFrame
          .on("joined-meeting", joinedCall)
          .on("left-meeting", leftCall)
          .on("participant-joined", newParticipant)
          .on("participant-left", updateEvent)
          .on("app-message", updateHandState)
          .on("error", showEvent);
        await callFrame.join({
          url: ownerLink,
          cssFile: "demo-css-grid.css",
        });

        console.log(
          " You are connected to",
          room.url,
          "\n",
          "Join from another tab or machine, or use the",
          "\n",
          "`callFrame.addFakeParticipant()` method to test",
          "\n",
          "this layout."
        );
      }

      async function toggleScreenShare() {
        if (!isCurrentlyScreenSharing) {
          callFrame.startScreenShare();
          let message = "sharing";
          callFrame.sendAppMessage({ message: message });
        } else {
          callFrame.stopScreenShare();
        }
      }

      // When the local user clicks to raise their hand
      async function toggleHandIcon() {
        if (!isCurrentlyRaisingHand) {
          isCurrentlyRaisingHand = true;
          // Change the display locally
          document.getElementById("handraise-label").innerHTML = "Lower hand";
          document.getElementById("local-hand").style.display = "block";
          // And, broadcast that new state as a new message, so the function to updateParticipantList is invoked again
          message = {
            handStatus: isCurrentlyRaisingHand,
          };
          callFrame.sendAppMessage(message, "*");
          //  PLACEHOLDER: for making raised hand more visible in the overlay
          //  callFrame.loadCss({cssText:
          //    `.daily-video-overlay.local {
          //      background-image: url(insert-link-to-raised-hand-here);
          //    }
          //    `
          //  });
        } else {
          isCurrentlyRaisingHand = false;
          document.getElementById("handraise-label").innerHTML = "Raise hand";
          document.getElementById("local-hand").style.display = "none";
          message = {
            handStatus: isCurrentlyRaisingHand,
          };
          callFrame.sendAppMessage(message, "*");
          // PLACEHOLDER: remove hand icon from local color bar
          // callFrame.updateParticipant("local", {
          //   styles: { cam: { div: { display: "block" } } },
          // });
        }
      }

      // What happens when everyone else on the call sees that caller join
      async function newParticipant() {
        isCurrentlyRaisingHand = false;
        message = {
          handStatus: isCurrentlyRaisingHand,
        };
        setTimeout(() => {
          callFrame.sendAppMessage(message, "*");
        }, 2500);
      }

      // When a user sends a message
      async function updateHandState(e) {
        showEvent(e);
        // Store the message before it disappears
        let id = e.fromId;
        let handStatus = e.data.handStatus;
        // Update the handState object to make sure it has the latest status for that hand
        handState[id] = handStatus;
        // Update the participant list to show proper state
        updateParticipantList();
      }

      // Update the participants on view (triggered after a message received and processed)
      async function updateParticipantList() {
        let ps = callFrame.participants();
        let wrapper = document.getElementById("ui-participant-guests");
        if (Object.keys(ps).length < 2) {
          document.getElementById("ui-local").style.display = "none";
          document.getElementById("ui-alone").style.display = "block";
          wrapper.innerHTML = "";
        } else {
          document.getElementById("ui-local").style.display = "none";
          document.getElementById("ui-alone").style.display = "none";
          wrapper.innerHTML = "";

          Object.keys(ps).forEach((p) => {
            if (p !== "local") {
              // We set the local display on load in the html, so we just do everyone else here
              let participant = ps[p];
              wrapper.innerHTML += `
        <div class="ui-participant-guest">
            <p>${participant.user_name || "Guest"}</p>
            <img id=${
              participant.session_id
            } src="../shared-assets/icon-raised-hand.png" alt="Raised hand" style="display:none"/>
        </div>`;
              if (handState[participant.session_id] === true) {
                document.getElementById(
                  `${participant.session_id}`
                ).style.display = "block";
              }
            }
          });
        }
      }
    </script>
  </body>
</html>
